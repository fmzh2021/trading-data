name: 股票实时监控

on:
  schedule:
    # 每个交易日的 9:30, 10:00, 11:00, 13:00, 14:00, 15:00 (北京时间) 执行
    # 北京时间 = UTC + 8，所以需要减 8 小时
    - cron: '0 1 29 2 *'  # 周一至周五
    
  workflow_dispatch:  # 允许手动触发
    inputs:
      stock_codes:
        description: '股票代码（多个用逗号分隔，如: 600036,000001,300001）。留空则使用 Repository Variables/Secrets 中的配置'
        required: false
        type: string

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          pip install -r requirements.txt

      - name: 运行股票监控
        env:
          # 股票代码配置优先级：手动输入（非空）> Repository Variables > Repository Secrets > 默认值
          INPUT_CODES: ${{ inputs.stock_codes }}
          VAR_CODES: ${{ vars.STOCK_CODES }}
          SECRET_CODES: ${{ secrets.STOCK_CODES }}
        run: |
          # 按优先级选择股票代码
          # 优先级：手动输入（非空）> Repository Variables > Repository Secrets > 默认值
          if [ -n "$INPUT_CODES" ]; then
            # 用户手动输入了值，使用手动输入
            STOCK_CODES="$INPUT_CODES"
            echo "✅ 使用手动输入的股票代码: $STOCK_CODES"
          elif [ -n "$VAR_CODES" ]; then
            # 手动输入为空，使用 Repository Variables
            STOCK_CODES="$VAR_CODES"
            echo "✅ 使用 Repository Variables 中的股票代码: $STOCK_CODES"
          elif [ -n "$SECRET_CODES" ]; then
            # Repository Variables 为空，使用 Repository Secrets
            STOCK_CODES="$SECRET_CODES"
            echo "✅ 使用 Repository Secrets 中的股票代码: $STOCK_CODES"
          else
            # 都没有配置，使用默认值
            STOCK_CODES="600036"
            echo "✅ 使用默认股票代码: $STOCK_CODES"
          fi
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "最终监控股票代码: $STOCK_CODES"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          export STOCK_CODES
          python stock_monitor.py

